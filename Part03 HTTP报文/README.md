# Part03 HTTP报文

### 3.1 报文流

##### 3.1.1 报文流入源端服务器
&emsp;&emsp;HTTP使用术语流入（inbound）和流出（outbound）来描述事物处理的方向。

##### 3.1.2 报文向下游流动
&emsp;&emsp;不管是是请求报文还是响应报文，所有报文都会向下游（downstream）流动，所有报文的发送者都在接收者的上游（upstream）。报文流方向不同，上下游的位置也是相对的。

### 3.2 报文组成部分
&emsp;&emsp;1、三部分：起始行（start line）、首部（header）、可选的主体（body）。  
&emsp;&emsp;2、起始行和首部是ASCII码文本，HTTP规定每行以\r\n（CRLF）作为结束标志，但稳健的程序也应该接受单个换行符作为行的终止。

##### 3.2.1 报文的语法

|部位|描述|
|---|---|
|方法（method）|客户端希望对资源执行的动作|
|请求URL（request-URL）|命名了所请求的资源|
|版本（version）|包括主要和次要版本，例如 HTTP/1.1|
|状态码（status-code）|描述请求过程中发生了什么|
|原因短语（reason-phrase）|原因短语只对人有意义|
|首部（header）|可以有0或多个首部，首部是键值对。首部以空行（CRLF）标志作为结束|
|实体的主体部分（entity-body）|主体可以是任意数据或空|

&emsp;&emsp;由于历史原因，在没有主体时，很多客户端和服务器都会省略首部后面的空白行，为了兼容，服务器和客户端都应该接受缺少空白行的报文。

##### 3.2.2 起始行
&emsp;&emsp;1、起始行的作用在于描述要做什么（what to do）和发生了什么（what happened）。  
&emsp;&emsp;2、请求行由方法+URL+HTTP版本，例如 GET /hello.html HTTP/1.1，所有字段以空格隔开。  
&emsp;&emsp;3、响应行由HTTP版本+数字状态码+原因短语，例如 HTTP/1.0 200 OK，所有字段以空格分隔。  
&emsp;&emsp;4、常用的HTTP方法：

|方法|描述|是否包含主体|
|---|---|---|
|GET|从服务器获取一份文档|否|
|HEAD|只从服务器获取文档首部|否|
|POST|向服务器发送要处理的数据|是|
|PUT|将请求的主体部分存储在服务器|是|
|TRACE|对可能经过代理服务器传送到服务器上去的报文进行追踪|否|
|OPTIONS|绝对可以在服务器上执行哪些方法|否|
|DELETE|从服务器上删除一份文档|否|

以上并不是HTTP的所有方法，除此之外，有些服务器会实现一些自己的请求方法，称为扩展方法。

&emsp;&emsp;5、状态码分类：

|整体范围|已定义范围|分类|
|---|---|---|
|100~199|100~101|信息提示|
|200~299|200~206|成功|
|300~399|300~305|重定向|
|400~499|400~415|客户端错误|
|500~599|500~505|服务器错误|

随着协议发展，可以接收到不在这个已定义范围内的状态码，可以根据其所处范围，视为其中普通一员来处理。

&emsp;&emsp;6、原因短语和状态码成对出现，原因短语本身无任何规定使用哪种形式。  
&emsp;&emsp;7、版本号不会被当做小数来处理，版本中的每个数字都会被当做单独的数字来处理。例如HTTP/2.22比HTTP/2.3高，因为22比3大。

##### 3.2.3 首部

&emsp;&emsp;1、起始行后面跟0或多个首部。  
&emsp;&emsp;2、首部分类：

|类型|描述|
|---|---|
|通用首部|既可以出现在请求报文和响应报文|
|请求首部|提供请求的信息|
|响应首部|提供响应的信息|
|实体首部|描述主体的长度和内容，或资源本身|
|扩展首部|规范中没有定义的首部|

&emsp;&emsp;3、过长的首部可以换行，但新的行要添加至少一个空格或制表符。例如：
```
server: test server head is 
   too long
```

##### 3.2.4 实体的主体部分

&emsp;&emsp;主体即为HTTP报文真正要传输的内容。

### 3.3 方法

##### 3.3.1 安全方法
&emsp;&emsp;GET和HEAD认为是安全的方法，但安全方法并不意味着什么动作都不执行，着取决于Web开发者。

##### 3.3.3 HEAD
&emsp;&emsp;HEAD 方法和GET很类似，但在响应中只返回首部，不返回实体。允许客户端在未获取资源情况下，预先得知资源的类型、响应码（是否成功）、是否被修改等。

##### 3.3.4 PUT
&emsp;&emsp;PUT让服务器用请求主体来创建一个所请求URL命名的新文档。如果已存在，则用新的替换。

##### 3.3.5 POST
&emsp;&emsp;通常用于支持HTML的表单。

##### 3.3.6 TRACE
&emsp;&emsp;TRACE请求会在目的服务器发送一个“环回”诊断，在行程最后一站的服务器会弹回一条TRACE响应，这样客户端就可以查看中间HTTP程序组成的请求响应链上，原始报文是否、以及何时被毁坏修改。TRACE响应的实体主体部分包含了响应服务器收到的请求的精确副本。

##### 3.3.7 OPTIONS
&emsp;&emsp;OPTIONS方法返回服务器支持的各种方法。

##### 3.3.9 扩展方法
&emsp;&emsp;对扩展方法应宽容处理，如果能在不破坏端到端行为的情况下，将带有未知方法的报文传递给下游服务器，代理就应该尝试传递这些报文。否则返回501 not Implemented。通常，都是对发送的内容严格一点，对接收的内容宽容一些来的策略来处理扩展方法。（严于律己，宽于律人，腻害了）。

### 3.4 状态码

##### 3.4.1 100~199--信息状态码
&emsp;&emsp;HTTP/1.1引入了信息状态码，由于信息状态码的复杂性和感知价值存在争论从而使用中受到限制。

|状态码|原因短语|含义|
|---|---|---|
|100|Continue|说明收到了请求的初始部分，请客户端继续|
|101|Switching Protocols|说明服务器正在根据客户端的指定，将协议转换成 Update 首部所列的协议|

&emsp;&emsp;客户端与100：  
&emsp;&emsp;1、如果客户端向服务器发送一个实体，并且愿意等待一个100的响应，那客户端就要向服务端发送一个携带100 Continue 的 Expect 请求首部，表示自己还要继续发送实体，否则应停止发送避免误导服务端。  
&emsp;&emsp;2、客户端只有在避免向服务端发送一个服务器无法处理的大实体时，才应该使用 100 Continue。  
&emsp;&emsp;3、如果客户端发送了有 100 Continue 的 Expect 首部，就不应该永远等待服务器发送 100 Continue 响应。超时后应该将实体发送出去。


&emsp;&emsp;服务端与100：  
&emsp;&emsp;1、服务器收到包含 100 Continue 的 Expect 首部时，会发送 100 Continue 响应或者一条错误状态码。服务器永远都不应该对没有发送包含 100 Continue 首部的客户端回送 100 Continue 响应。    
&emsp;&emsp;2、有可能在发送 100 响应之前收到了新的实体，表明客户端决定继续发送数据，此时服务端不再回送 100 状态码。
  
&emsp;&emsp;代理与100：  
&emsp;&emsp;1、代理收到一条包含 100 Continue 的 Expect 首部时，首先如果吓一跳确认支持HTTP/1.1(100是1.1引进的)或者并不知道下一跳的版本情况，就转发给下一跳，否则返回 417 Expectation Failed。

##### 3.4.2 200~299--成功状态码

|状态码|原因短语|含义|
|---|-------|---|
|200|OK|请求成功，响应实体的主体包含了请求的内容|
|201|Created|用于创建对象的请求。响应的实体主体中应该包含各种引用了已创建的资源URL，Location首部包含的是最具体的引用，服务器必须在发送之前创建好对象|
|202|Accepted|请求已被接受，但服务器还未对其做任何操作。服务器不能保证会完成这个请求，在客户端看来是一件成功了。返回的实体里应该包含对请求状态的描述，甚至估计的完成时间|
|203|Non-Authoritative Information|实体首部不是来自源服务器，而是来自资源副本|
|204|No Content| 只有起始行和首部，没有主体。主要用于在浏览器不转为显示新文档的情况，例如刷新一个表单|
|205|Reset Content|也是用于浏览器的代码。告诉浏览器清除当前页面中的所有HTML表单元素|
|206|Partial Content|成功执行了一部分请求，响应中必须包含Content-Range, Date, ETag, Content-Location首部|

##### 3.4.3 300~399--重定向状态码
&emsp;&emsp;1、重定向代码要么告诉客户端用替代位置来访问资源，要么提供一个替代的响应，而非资源。  
&emsp;&emsp;2、如果资源被移走，可同时发送一个Location首部来告知资源已经移走，及哪里可以找到它。客户端可以在不打扰用户使用情况下转向新的资源  

|状态码|原因短语|含义|
|----|----|----|
|300|Multiple Choices|请求的URL指向多个资源时返回此状态码，例如多语言的HTML文档。返回时同时携带一个选择列表，让用户来选择。服务器可以在Location首部里指定首选的URL|
|301|Moved Permanently|资源已被移除使用。响应Location里应包含新资源的URL|
|302|Found|与301类似，客户端暂时用Location首部的URL来*临时*定位资源，以后的请求还是用老URL|
|303|See Other|告知客户端用响应里Location首部的URL去请求资源，其主要目的是允许POST请求的响应将客户端定位到某个资源上去|
|304|Not Modified|不好描述，举个🌰吧，客户端发送特殊的If-Modified-Since首部，说明只读取这个首部时间段后被修改过的文档，如果文档未被修改，服务器就返回304，而不是文档内容，也即是，这个响应不应该包含实体的主体部分|
|305|Use Proxy|说明必须通过代理访问，代理的位置由Location首部给出|
|306|未使用|未使用|
|307|Temporary Redirect|与301类似，客户端暂时用Location首部的URL来*临时*定位资源，以后的请求还是用老URL|

&emsp;&emsp;3、上面，302、303、307之间存在一些交叉，主要是HTTP/1.0和HTTP/1.1对这些状态码的处理不同造成。  
&emsp;&emsp;a）在HTTP/1.0里，客户端发起一个POST请求，在响应中收到302后，它会根据Location首部的URL发起GET，不再是以前的POST，服务器也是这么期望的。  
&emsp;&emsp;b）在HTTP/1.1里，是用303来同样实现上面的行为（用GET重定向之前的POST）。于是在1.1版本里规定，用307取代302来重定向，原来的302保留来为1.0使用。

##### 3.4.4--客户端错误状态码
&emsp;&emsp;大部分错误都由浏览器处理，只有少部分如404会被用户知道。

|状态码|原因短语|含义|
|-----|-------|----|
|400|Bad Request|告知客户端你丫发送了错误请求|
|401|Unauthorized|与适当的首部返回，要求客户端请求资源钱对自己进行认证|
|402|Payment Required|已保留，未来使用|
|403|Forbidden|说明请求被拒绝。如果想说明为什么拒绝，可以在实体的主体中说明。但此验证码通常在服务器不想说明拒绝原因的时候会用……………………|
|404|Not Found|说明服务器找不到URL对应的资源，通常响应包含一个实体，以便回显给客户端显示给用户看|
|405|Method Not Allowed|所请求的URL不支持该方法时使用。应该在响应中包含Allow首部，告知可以使用的方法|
|406|Not Acceptable|请求李可以指定客户端愿意接受的实体类型，但服务器根据对应URL找不到匹配的资源时使用|
|407|Proxy Authentication Required|与401类似，但用于代理服务器|
|408|Request Timeout|如果完成请求话费的时间太长，服务器可以回送此状态码，并关闭连接。超时时间随服务器而异，一般对合法请求来说都是足够的|

是不是有点多啊，一屏都显示不完，休息下先……  

|状态码|原因短语|含义|
|-----|-------|----|
|409|Conflict|服务器担心请求可能在资源上引起冲突时回送此状态码，响应实体应该包含冲突主体|
|410|Gone|与404类似，只是服务器曾经有过该资源。主要用于Web站点维护，以便移除情况下通知客户端|
|411|Length Required|服务器要求请求报文首部包含Content-Length首部时使用|
|412|Precondition Failed|客户端的请求条件中有一个失败时候使用(Expect首部就是条件)|
|413|Request Entity Too Large|客户端发送的实体超过服务器能处理的大小时使用|
|414|Request URL Too Long|客户端发送的URL长度超过服务器能处理的长度时使用|
|415|Unsupported Media Type|服务器无法支持或理解客户端发送的内容类型时使用|
|416|Request Range Not Satisfiable|请求报文的请求范围，在服务器认为无效或无法满足时使用|
|417|Expection Failed|请求的Except首部包含一个期望，但服务器无法满足时使用|

##### 3.4.5--500~599服务器错误状态码
&emsp;&emsp;500+错误可能是服务器、网关、代理发生了异常。

|状态码|原因短语|含义|
|-----|-------|----|
|500|Internal Server Error|服务器遇到一个妨碍它提供服务的错误时使用|
|501|Not Implement|请求超出了服务器的能力范围，例如不支持的请求方法|
|502|Bad Gateway|代理或网关从下一条链路收到了一条伪响应时使用|
|503|Service Unavailable|服务器当前无法提供此服务，但将来阔以。如果服务器知道服务在什么时候可用，可以在响应中加入Retry-After首部|
|504|Gateway Timeout|与408类似，只是这里的响应来自一个网关或者代理，在等待另一个服务器的响应时超时了|
|505|HTTP Version Not Supported|服务器收到的请求使用了它不支持或不愿支持的协议版本时使用|


### 3.5 首部
&emsp;&emsp;下面接受HTTP1.1明确定义了的首部。

##### 3.5.1 通过首部

|首部|描述|
|-----|-------|
|Connection|允许客户端/服务器指定与请求/响应相关的选项|
|Date|提供日期的时间和标志，说明报文的创建时间。并列出了可接受日期的格式|
|MIME-Version|给出了发送端使用的MIME版本|
|Trailer|如果报文采用了分块传输编码，用这个首部来列出位于trailer部分的首部集合|
|Transfer-Encoding|告知接收端为了报文的可靠传输，对报文应该采取的编码方式|
|Update|给出了发送端可能想要“升级”使用的新版本或协议|
|Via|显示了报文经过了哪些中间节点（网关、代理）|

##### 3.5.2 请求首部

请求的信息性首部

|首部|描述|
|-----|----|
|Client-IP|客户端的IP地址|
|From|客户端用户的E-mail地址|
|Host|服务器的hostname + port|
|Referer|请求URI的文档的URL|
|UA-Color|客户端显示器相关信息|
|UA-CPU|客户端CPU类型或制造商|
|UA-Disp|客户端显示器能力相关信息|
|UA-OS|客户端的操作系统名称及版本|
|UA-Pixels|客户端显示器的像素信息|
|User-Agent|发起请求的应用程序名称|

 - Accept首部  
&emsp;&emsp;告知服务器客户端的能力及喜好。有助于服务端对发送的内容作出更为明智的决定。

|首部|描述|
|----|----|
|Accept|告诉服务器能发送哪些媒体类型|
|Accept-Chartset|告诉服务器可以发送哪些字符集|
|Accept-Encoding|告诉服务器可以发送哪些编码方式|
|Accept-Language|告诉服务器可以发送哪些语言|
|TE|告诉服务器可以使用哪些扩展传输编码|

 - 条件请求首部
&emsp;&emsp;客户端希望对请求加上某些限制时使用（还记得304么？）。


|首部|描述|
|------|-----|
|Expect|列出客客户端希望服务器应有的行为|
|If-Match|如果和文档的标记匹配，就获取这份文档|
|If-Modified-Since|在指定时间后修改过该资源时返回该文档|
|If-None-Match|如果与当前文档不匹配，就获取这份文档|
|If-Range|允许对文档的某个范围进行条件请求|
|If-Unmodified-Since|在指定时间后没有修改过该资源时返回该文档|
|Range|如果服务器支持范围请求，就返回资源指定的范围|


 - 安全请求首部
&emsp;&emsp;常用安全首部：

|首部|描述|
|----|------|
|Authorization|包含客户端提供给服务器用于身份认证的数据|
|Cookie|客户端用它向服务器传送一个令牌，非安全，隐含了安全功能|
|Cookie2|用来说明请求的支持的Cookie的版本|

 - 代理请求首部

|首部|描述|
|-----|-----|
|Max-Forward|通往源服务器时，将请求转发给其他代理或网关的最大次数|
|Proxy-Authorization|与Authorization相同，用在与代理认证时使用|
|Proxy-Connection|与Connection类型，用在与代理建立连接时使用|

##### 3.5.3 响应首部
响应的信息首部

|首部|描述|
|----|----|
|Age|响应持续时间，按时响应是从中间节点传输过来的|
|Public|服务器为其资源支持的方法列表|
|Retry-After|如果资源不可用，在此时间或日期重试|
|Server|服务器程序的名称和版本|
|Warning|比原有短语更详细一些的警告报文|

 - 协商首部
&emsp;&emsp;服务里用来传递可协商资源的信息。例如国际化时一个文件存在多个版本。主要首部有：  

|首部|描述|
|----|----|
|Accept-Ranges|对此资源来说，服务器可以接受的范围类型|
|Vary|服务器查看的其他首部列表。也即这是一个首部列表，服务器会根据这些首部选出最合适的内容发送给客户端|

 - 安全响应首部
&emsp;&emsp;和前面的安全请求首部相关。结合起来就是HTTP的质询/响应机制的响应侧。基本的安全响应首部如下：

|首部|描述|
|----|-----|
|Proxy-Authenticate|来自代理对客户端的质询列表|
|Set-Cookie|不是真正的安全首部，隐含安全功能|
|Set-Cookie2|与Set-Cookie类似|
|WWW-Authenticate|来自服务器对客户端的质询列表|


##### 3.5.4 实体首部

&emsp;&emsp;实体首部包含了大量关于实体的消息。由于请求和响应都有实体，所以这两种类型的报文都可以拥有实体首部。
&emsp;&emsp;实体信息首部：

|首部|描述|
|----|----|
|Allow|可以对此实体执行的请求方法|
|Location|告知客户端实体的实际位置；将接收端重定向到资源实际位置|

 - 内容首部

&emsp;&emsp;提供了实体的类型、尺寸等。例如浏览器可以查看类型，得知如何显示对象。

|首部|描述|
|-----|-----|
|Content-Base|解析主体中的相对URL时使用的基础URL|
|Content-Encoding|对主体执行的编码方式|
|Content-Language|理解主体时最适合的自然语言|
|Content-Length|主体的长度或尺寸|
|Content-Location|资源实际所处的位置|
|Content-MD5|主体的MD5校验和|
|Content-Range|在整个资源中此实体表示的字节范围|
|Content-Type|主体的对象类型|

 - 实体缓存首部

 &emsp;&emsp;通用缓存首部说明了如何、何时使用缓存，实体的缓存首部提供被缓存实体的消息。例如，为验证缓存的资源副本是否依然有效提供所需消息，以及提供更好的估计已缓存资源何时失效所需的线索。

 &emsp;&emsp;部分缓存首部：

 |首部|描述|
 |-----|------|
 |ETag|与实体相关的标记，及某个资源版本的标识符|
 |Last-Modified|实体最后一次被修改的日期|






























